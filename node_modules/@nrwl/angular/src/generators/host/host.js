"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const devkit_1 = require("@nrwl/devkit");
const application_1 = require("../application/application");
const remote_1 = require("../remote/remote");
const project_1 = require("../utils/project");
const ts = require("typescript");
const ast_utils_1 = require("../../utils/nx-devkit/ast-utils");
function host(tree, options) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const projects = (0, devkit_1.getProjects)(tree);
        const remotesToGenerate = [];
        const remotesToIntegrate = [];
        if (options.remotes && options.remotes.length > 0) {
            options.remotes.forEach((remote) => {
                if (!projects.has(remote)) {
                    remotesToGenerate.push(remote);
                }
                else {
                    remotesToIntegrate.push(remote);
                }
            });
        }
        const installTask = yield (0, application_1.default)(tree, Object.assign(Object.assign({}, options), { mf: true, mfType: 'host', routing: true, remotes: remotesToIntegrate !== null && remotesToIntegrate !== void 0 ? remotesToIntegrate : [], port: 4200, federationType: options.dynamic ? 'dynamic' : 'static', skipFormat: true }));
        for (const remote of remotesToGenerate) {
            yield (0, remote_1.default)(tree, Object.assign(Object.assign({}, options), { name: remote, host: (0, project_1.normalizeProjectName)(options.name, options.directory), skipFormat: true }));
        }
        routeToNxWelcome(tree, options);
        if (!options.skipFormat) {
            yield (0, devkit_1.formatFiles)(tree);
        }
        return installTask;
    });
}
exports.default = host;
function routeToNxWelcome(tree, options) {
    const { sourceRoot } = (0, devkit_1.readProjectConfiguration)(tree, (0, project_1.normalizeProjectName)(options.name, options.directory));
    const remoteRoutes = options.remotes && Array.isArray(options.remotes)
        ? options.remotes.reduce((routes, remote) => `${routes}\n<li><a routerLink='${(0, project_1.normalizeProjectName)(remote, options.directory)}'>${(0, devkit_1.names)(remote).className}</a></li>`, '')
        : '';
    tree.write((0, devkit_1.joinPathFragments)(sourceRoot, 'app/app.component.html'), `<ul class="remote-menu">
<li><a routerLink='/'>Home</a></li>
${remoteRoutes}
</ul>
<router-outlet></router-outlet>
`);
    const pathToHostAppModule = (0, devkit_1.joinPathFragments)(sourceRoot, 'app/app.module.ts');
    const hostAppModule = tree.read(pathToHostAppModule, 'utf-8');
    if (!hostAppModule.includes('RouterModule.forRoot(')) {
        return;
    }
    let sourceFile = ts.createSourceFile(pathToHostAppModule, hostAppModule, ts.ScriptTarget.Latest, true);
    sourceFile = (0, ast_utils_1.addRoute)(tree, pathToHostAppModule, sourceFile, `{
         path: '', 
         component: NxWelcomeComponent
     }`);
}
//# sourceMappingURL=host.js.map